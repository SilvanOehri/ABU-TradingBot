<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Bot - Strategy Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f8f9fa;
        color: #333;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        background: #343a40;
        color: white;
        padding: 20px 0;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .header h1 {
        text-align: center;
        font-size: 28px;
      }
      .back-btn {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 6px;
        margin-bottom: 20px;
        transition: background 0.3s;
      }
      .back-btn:hover {
        background: #0056b3;
      }
      .card {
        background: white;
        padding: 30px;
        margin-bottom: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .metric {
        text-align: center;
        padding: 25px;
        border-radius: 10px;
        color: #1a1a1a;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .metric-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .metric-success {
        background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
      }
      .metric-info {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      }
      .metric-warning {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      }
      .metric h3 {
        font-size: 32px;
        margin-bottom: 8px;
        font-weight: 700;
      }
      .metric p {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 5px;
      }
      .metric .metric-info-text {
        font-size: 11px;
        opacity: 0.8;
        font-style: italic;
        margin-top: 8px;
        line-height: 1.3;
      }
      .loading {
        text-align: center;
        padding: 60px;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        background: #dc3545;
        color: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
      }
      .hidden {
        display: none;
      }
      .chart-container {
        position: relative;
        height: 500px;
        margin: 20px 0;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin: 30px 0;
        max-width: 600px;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        border-left: 4px solid #007bff;
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .stat-card h4 {
        margin: 0 0 8px 0;
        font-size: 22px;
        color: #007bff;
      }
      .stat-card p {
        margin: 0 0 5px 0;
        font-size: 13px;
        color: #666;
        font-weight: 600;
      }
      .stat-card .info {
        margin: 8px 0 0 0;
        font-size: 11px;
        color: #888;
        font-style: italic;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="container">
        <h1>Trading Bot - Strategy Performance</h1>
      </div>
    </div>

    <div class="container">
      <a href="/" class="back-btn">← Zurück zum Dashboard</a>

      <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Lade Strategy Chart...</p>
      </div>

      <!-- Error State -->
      <div id="error" class="error hidden">
        <h3>Fehler beim Laden</h3>
        <p id="error-message"></p>
      </div>

      <!-- Content -->
      <div id="content" class="hidden">
        <div class="card">
          <h2 id="strategy-title">Strategy Details</h2>

          <!-- Strategy Description -->
          <div
            id="strategy-description"
            class="hidden"
            style="
              background: #e3f2fd;
              padding: 15px 20px;
              border-radius: 8px;
              margin: 20px 0;
              border-left: 4px solid #2196f3;
            "
          >
            <p
              style="
                margin: 0;
                font-size: 15px;
                line-height: 1.6;
                color: #1565c0;
              "
            ></p>
          </div>

          <div class="metrics">
            <div class="metric metric-primary">
              <h3 id="final-value">$0</h3>
              <p>Endkapital</p>
              <div class="metric-info-text">
                Portfolio-Wert am Ende des Backtest-Zeitraums
              </div>
            </div>
            <div class="metric metric-success">
              <h3 id="return-pct">0%</h3>
              <p>Rendite</p>
              <div class="metric-info-text">
                Prozentuale Wertsteigerung seit Beginn
              </div>
            </div>
            <div class="metric metric-info">
              <h3 id="profit-loss">$0</h3>
              <p>Gewinn/Verlust</p>
              <div class="metric-info-text">
                Absoluter Gewinn oder Verlust in Dollar
              </div>
            </div>
            <div class="metric metric-warning">
              <h3 id="total-trades">0</h3>
              <p>Trades</p>
              <div class="metric-info-text">
                Anzahl der durchgeführten Kauf- und Verkauf-Transaktionen
              </div>
            </div>
          </div>

          <!-- Portfolio Chart -->
          <div class="card">
            <h3>Portfolio-Entwicklung über Zeit</h3>
            <div class="chart-container">
              <canvas id="portfolio-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const strategyId = {{ strategy_id }};

      document.addEventListener('DOMContentLoaded', () => {
          console.time('⚡ Chart Load Time');
          loadStrategy();
      });

      async function loadStrategy() {
          try {
              const response = await fetch(`/api/strategy/${strategyId}`);
              const result = await response.json();

              if (result.success) {
                  displayStrategy(result.data);
              } else {
                  showError(result.error);
              }

              console.timeEnd('⚡ Chart Load Time');
          } catch (error) {
              showError(`Network Error: ${error.message}`);
              console.timeEnd('⚡ Chart Load Time');
          }
      }

      function displayStrategy(data) {
          // Update metrics
          document.getElementById('strategy-title').textContent = data.strategy_name;

          // Display description if available
          if (data.description && data.description.trim()) {
              const descElement = document.getElementById('strategy-description');
              descElement.querySelector('p').textContent = data.description;
              descElement.classList.remove('hidden');
          }

          document.getElementById('final-value').textContent = formatMoney(data.final_value);
          document.getElementById('return-pct').textContent = `${data.return_percentage.toFixed(2)}%`;
          document.getElementById('profit-loss').textContent = formatMoney(data.profit_loss);
          document.getElementById('total-trades').textContent = data.total_trades;

          // Color coding
          const returnElement = document.getElementById('return-pct').parentElement;
          const profitElement = document.getElementById('profit-loss').parentElement;

          if (data.return_percentage > 0) {
              returnElement.style.background = 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)';
              profitElement.style.background = 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)';
          } else if (data.return_percentage < 0) {
              returnElement.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)';
              profitElement.style.background = 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)';
          }

          // Create chart
          createPortfolioChart(data);

          // Show content
          document.getElementById('loading').className = 'loading hidden';
          document.getElementById('content').className = '';
      }

      function createPortfolioChart(data) {
          const ctx = document.getElementById('portfolio-chart').getContext('2d');

          // Create labels
          // Create labels - show every ~30th day to keep it clean
          const totalDays = data.portfolio_values.length;
          const labels = data.portfolio_values.map((_, index) => `Tag ${index + 1}`);

          // Color based on performance
          const isPositive = data.return_percentage > 0;
          const lineColor = isPositive ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)';
          const bgColor = isPositive ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)';

          new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Portfolio Wert',
                      data: data.portfolio_values,
                      borderColor: lineColor,
                      backgroundColor: bgColor,
                      borderWidth: 3,
                      fill: true,
                      tension: 0.4,
                      pointRadius: 0,
                      pointHoverRadius: 6,
                      pointHoverBackgroundColor: lineColor,
                      pointHoverBorderColor: '#fff',
                      pointHoverBorderWidth: 3
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          display: false
                      },
                      tooltip: {
                          mode: 'index',
                          intersect: false,
                          backgroundColor: 'rgba(0, 0, 0, 0.8)',
                          titleColor: '#fff',
                          bodyColor: '#fff',
                          padding: 12,
                          displayColors: false,
                          callbacks: {
                              title: function(context) {
                                  const dayIndex = context[0].dataIndex;
                                  const date = new Date();
                                  date.setDate(date.getDate() - (context[0].dataset.data.length - 1 - dayIndex));
                                  return `Tag ${dayIndex} - ${date.toLocaleDateString('de-CH')}`;
                              },
                              label: function(context) {
                                  return 'Portfolio: ' + formatMoney(context.parsed.y);
                              }
                          }
                      }
                  },
                  scales: {
                      x: {
                          display: true,
                          grid: {
                              display: false
                          },
                          ticks: {
                              maxTicksLimit: 20,
                              autoSkip: true,
                              maxRotation: 0,
                              minRotation: 0,
                              color: '#666'
                          }
                      },
                      y: {
                          display: true,
                          beginAtZero: false,
                          grace: '5%',
                          grid: {
                              color: 'rgba(0, 0, 0, 0.05)'
                          },
                          ticks: {
                              color: '#666',
                              callback: function(value) {
                                  return formatMoney(value);
                              }
                          }
                      }
                  },
                  interaction: {
                      mode: 'nearest',
                      axis: 'x',
                      intersect: false
                  }
              }
          });
      }

      function showError(message) {
          document.getElementById('error-message').textContent = message;
          document.getElementById('loading').className = 'loading hidden';
          document.getElementById('error').className = 'error';
      }

      function formatMoney(value) {
          return new Intl.NumberFormat('de-DE', {
              style: 'currency',
              currency: 'USD',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
          }).format(value);
      }
    </script>
  </body>
</html>
