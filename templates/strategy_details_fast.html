<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‚ö° Trading Bot - Ultra Fast Strategy</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* MINIMAL CSS - INSTANT LOADING */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.4;
        color: #333;
        background: #f8f9fa;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        background: #343a40;
        color: white;
        padding: 15px 0;
        margin-bottom: 20px;
      }
      .header h1 {
        text-align: center;
        font-size: 24px;
      }
      .back-btn {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 8px 16px;
        text-decoration: none;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .back-btn:hover {
        background: #0056b3;
      }
      .card {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .metric {
        text-align: center;
        padding: 20px;
        border-radius: 8px;
        color: white;
      }
      .metric-primary {
        background: #007bff;
      }
      .metric-success {
        background: #28a745;
      }
      .metric-info {
        background: #17a2b8;
      }
      .metric-warning {
        background: #ffc107;
        color: #333;
      }
      .metric h3 {
        font-size: 28px;
        margin-bottom: 5px;
      }
      .metric p {
        font-size: 14px;
        opacity: 0.9;
      }
      .loading {
        text-align: center;
        padding: 40px;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        background: #dc3545;
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .hidden {
        display: none;
      }
      .performance-chart {
        background: linear-gradient(45deg, #007bff, #28a745);
        height: 100px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        margin: 20px 0;
      }

      /* TRADE TABLE STYLES */
      .trade-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .trade-table th {
        background: #343a40;
        color: white;
        padding: 12px 8px;
        font-size: 14px;
        text-align: left;
      }
      .trade-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #eee;
        font-size: 13px;
      }
      .trade-table tr:hover {
        background: #f8f9fa;
      }
      .signal-buy {
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .signal-sell {
        background: #dc3545;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .signal-hold {
        background: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
        border-left: 4px solid #007bff;
      }
      .stat-card h4 {
        margin: 0 0 5px 0;
        font-size: 18px;
        color: #007bff;
      }
      .stat-card p {
        margin: 0;
        font-size: 12px;
        color: #666;
      }
      .pagination-simple {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 20px 0;
      }
      .pagination-simple button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
      }
      .pagination-simple button:hover {
        background: #f8f9fa;
      }
      .pagination-simple button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .current-page {
        background: #007bff !important;
        color: white !important;
        border-color: #007bff !important;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="container">
        <h1>‚ö° Trading Bot - Strategy Details (Ultra Fast)</h1>
      </div>
    </div>

    <div class="container">
      <a href="/" class="back-btn">‚Üê Zur√ºck zum Dashboard</a>

      <!-- Loading State -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Lade Strategy Details...</p>
      </div>

      <!-- Error State -->
      <div id="error" class="error hidden">
        <h3>‚ö†Ô∏è Fehler beim Laden</h3>
        <p id="error-message"></p>
      </div>

      <!-- Content -->
      <div id="content" class="hidden">
        <div class="card">
          <h2 id="strategy-title">Strategy Details</h2>

          <div class="metrics">
            <div class="metric metric-primary">
              <h3 id="final-value">$0</h3>
              <p>Endkapital</p>
            </div>
            <div class="metric metric-success">
              <h3 id="return-pct">0%</h3>
              <p>Rendite</p>
            </div>
            <div class="metric metric-info">
              <h3 id="profit-loss">$0</h3>
              <p>Gewinn/Verlust</p>
            </div>
            <div class="metric metric-warning">
              <h3 id="total-trades">0</h3>
              <p>Trades</p>
            </div>
          </div>

          <!-- Portfolio Performance Chart -->
          <div class="card">
            <h3>üìà Portfolio-Entwicklung</h3>
            <canvas
              id="portfolio-chart"
              style="width: 100%; height: 400px"
            ></canvas>
          </div>

          <!-- Trading Statistics -->
          <div class="stats-grid" id="trading-stats">
            <div class="stat-card">
              <h4 id="win-rate">-%</h4>
              <p>Gewinnrate</p>
            </div>
            <div class="stat-card">
              <h4 id="sharpe-ratio">-</h4>
              <p>Sharpe Ratio</p>
            </div>
            <div class="stat-card">
              <h4 id="max-drawdown">-%</h4>
              <p>Max Drawdown</p>
            </div>
            <div class="stat-card">
              <h4 id="avg-trade">$-</h4>
              <p>√ò Trade</p>
            </div>
          </div>

          <!-- Trade History -->
          <div class="card">
            <h3>üìä Trade Historie - Nur echte Buy/Sell Trades</h3>
            <p>
              <small
                >Zeigt alle <span id="total-trades-text">0</span> echten Kauf-
                und Verkaufs-Trades (HOLD Signale werden ausgeblendet)</small
              >
            </p>

            <div class="pagination-simple">
              <button onclick="changePage(-1)" id="prev-btn">
                ‚óÄ Vorherige
              </button>
              <span
                >Seite <span id="current-page">1</span> von
                <span id="total-pages">1</span></span
              >
              <button onclick="changePage(1)" id="next-btn">N√§chste ‚ñ∂</button>
            </div>

            <table class="trade-table" id="trades-table">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Signal</th>
                  <th>Preis</th>
                  <th>Anteile</th>
                  <th>Kapital</th>
                  <th>Portfolio</th>
                  <th>√Ñnderung</th>
                </tr>
              </thead>
              <tbody id="trades-body">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px">
                    <div class="spinner"></div>
                    Lade Trades...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div
            style="
              text-align: center;
              padding: 20px;
              background: #e7f3ff;
              border-radius: 8px;
              margin-top: 20px;
            "
          >
            <strong>‚ö° Optimiert f√ºr Geschwindigkeit!</strong><br />
            <small
              >Charts wurden vereinfacht, aber alle Trade-Details sind
              verf√ºgbar.</small
            >
          </div>
        </div>
      </div>
    </div>

    <script>
      // ULTRA MINIMAL JAVASCRIPT - INSTANT EXECUTION
      const strategyId = {{ strategy_id }};
      let allTrades = [];
      let currentPage = 1;
      const tradesPerPage = 10;

      // INSTANT DOM LOADING
      document.addEventListener('DOMContentLoaded', () => {
          console.time('‚ö° Strategy Load Time');
          loadStrategy();
      });

      async function loadStrategy() {
          try {
              // FETCH WITH MINIMAL OPTIONS
              const response = await fetch(`/api/strategy/${strategyId}`);
              const result = await response.json();

              if (result.success) {
                  displayStrategy(result.data);
              } else {
                  showError(result.error);
              }

              console.timeEnd('‚ö° Strategy Load Time');
          } catch (error) {
              showError(`Network Error: ${error.message}`);
              console.timeEnd('‚ö° Strategy Load Time');
          }
      }

      function displayStrategy(data) {
          // MINIMAL DOM UPDATES - BATCH OPERATIONS
          document.getElementById('strategy-title').textContent = data.strategy_name;
          document.getElementById('final-value').textContent = formatMoney(data.final_value);
          document.getElementById('return-pct').textContent = `${data.return_percentage.toFixed(2)}%`;
          document.getElementById('profit-loss').textContent = formatMoney(data.profit_loss);
          document.getElementById('total-trades').textContent = data.total_trades;

          // NEW: Statistics
          document.getElementById('win-rate').textContent = `${(data.win_rate * 100).toFixed(1)}%`;
          document.getElementById('sharpe-ratio').textContent = data.sharpe_ratio.toFixed(2);
          document.getElementById('max-drawdown').textContent = `${data.max_drawdown.toFixed(1)}%`;

          // Calculate average trade
          const avgTrade = data.profit_loss / data.total_trades;
          document.getElementById('avg-trade').textContent = formatMoney(avgTrade);

          // Portfolio summary
          const startValue = data.portfolio_values[0] || 100000;
          const endValue = data.final_value;
          document.getElementById('portfolio-summary').textContent =
              `${formatMoney(startValue)} ‚Üí ${formatMoney(endValue)}`;

          // Trade count
          document.getElementById('total-trades-text').textContent = data.total_trades;

          // SIMPLE COLOR CODING
          const returnElement = document.getElementById('return-pct').parentElement;
          const profitElement = document.getElementById('profit-loss').parentElement;

          if (data.return_percentage > 0) {
              returnElement.className = 'metric metric-success';
              profitElement.className = 'metric metric-success';
          } else if (data.return_percentage < 0) {
              returnElement.className = 'metric metric-danger';
              profitElement.className = 'metric metric-danger';
              returnElement.style.background = '#dc3545';
              profitElement.style.background = '#dc3545';
          }

          // LOAD TRADES - NUR BUY UND SELL, keine HOLD
          const allTradesRaw = data.trade_history || [];
          allTrades = allTradesRaw.filter(trade => trade.signal === 'buy' || trade.signal === 'sell');

          console.log(`üìä Gefilterte Trades: ${allTrades.length} von ${allTradesRaw.length} Tagen (nur Buy/Sell)`);
          displayTrades();          // SHOW CONTENT - HIDE LOADING
          document.getElementById('loading').className = 'loading hidden';
          document.getElementById('content').className = '';
      }

      function displayTrades() {
          const start = (currentPage - 1) * tradesPerPage;
          const end = start + tradesPerPage;
          const tradesToShow = allTrades.slice(start, end);

          const tbody = document.getElementById('trades-body');
          tbody.innerHTML = '';

          if (tradesToShow.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Keine Trades gefunden</td></tr>';
              return;
          }

          tradesToShow.forEach(trade => {
              const row = document.createElement('tr');

              const signalClass = `signal-${trade.signal}`;
              const changeColor = trade.change > 0 ? 'color: #28a745;' : trade.change < 0 ? 'color: #dc3545;' : '';

              row.innerHTML = `
                  <td>${trade.date}</td>
                  <td><span class="${signalClass}">${trade.signal.toUpperCase()}</span></td>
                  <td>${formatMoney(trade.price)}</td>
                  <td>${trade.shares_before.toFixed(2)} ‚Üí ${trade.shares_after.toFixed(2)}</td>
                  <td>${formatMoney(trade.capital_after)}</td>
                  <td><strong>${formatMoney(trade.portfolio_value)}</strong></td>
                  <td style="${changeColor}">${trade.change > 0 ? '+' : ''}${formatMoney(trade.change)}</td>
              `;

              tbody.appendChild(row);
          });

          // Update pagination
          const totalPages = Math.ceil(allTrades.length / tradesPerPage);
          document.getElementById('current-page').textContent = currentPage;
          document.getElementById('total-pages').textContent = totalPages;

          document.getElementById('prev-btn').disabled = currentPage === 1;
          document.getElementById('next-btn').disabled = currentPage === totalPages;
      }

      function changePage(direction) {
          const totalPages = Math.ceil(allTrades.length / tradesPerPage);
          const newPage = currentPage + direction;

          if (newPage >= 1 && newPage <= totalPages) {
              currentPage = newPage;
              displayTrades();
          }
      }

      function showError(message) {
          document.getElementById('error-message').textContent = message;
          document.getElementById('loading').className = 'loading hidden';
          document.getElementById('error').className = 'error';
      }

      function formatMoney(value) {
          return new Intl.NumberFormat('en-US', {
              style: 'currency',
              currency: 'USD',
              minimumFractionDigits: 0,
              maximumFractionDigits: 0
          }).format(value);
      }
    </script>
  </body>
</html>
