<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trading Bot - Strategien Vergleich</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='css/dashboard.css') }}"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">
          <i class="fas fa-robot"></i> Trading Bot
        </a>
        <div class="navbar-nav flex-row">
          <a class="nav-link me-3" href="/">
            <i class="fas fa-arrow-left"></i> Zurück zum Dashboard
          </a>
          <span class="navbar-text">
            <i class="fas fa-chart-area"></i> Strategien Vergleich
          </span>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
      <!-- Strategy Selection -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>
                <i class="fas fa-layer-group"></i> Strategien für Vergleich
                auswählen
              </h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Führen Sie zuerst einen Backtest durch, um Strategien
                vergleichen zu können.
                <a href="/" class="btn btn-primary btn-sm ms-2">
                  <i class="fas fa-play"></i> Zum Dashboard
                </a>
              </div>

              <div id="strategySelection" style="display: none">
                <div class="row">
                  <div class="col-md-8">
                    <div id="strategyCheckboxes" class="row">
                      <!-- Strategy checkboxes will be populated here -->
                    </div>
                  </div>
                  <div class="col-md-4">
                    <button
                      class="btn btn-primary w-100"
                      onclick="compareSelectedStrategies()"
                    >
                      <i class="fas fa-chart-line"></i> Strategien vergleichen
                    </button>
                    <button
                      class="btn btn-outline-secondary w-100 mt-2"
                      onclick="selectAllStrategies()"
                    >
                      <i class="fas fa-check-double"></i> Alle auswählen
                    </button>
                    <button
                      class="btn btn-outline-secondary w-100 mt-2"
                      onclick="clearSelection()"
                    >
                      <i class="fas fa-times"></i> Auswahl löschen
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Comparison Charts -->
      <div id="comparisonContainer" style="display: none">
        <!-- Portfolio Performance Comparison -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5>
                  <i class="fas fa-chart-line"></i> Portfolio Performance
                  Vergleich
                </h5>
              </div>
              <div class="card-body">
                <canvas
                  id="portfolioComparisonChart"
                  style="max-height: 500px"
                ></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5>
                  <i class="fas fa-table"></i> Performance Metriken Vergleich
                </h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table
                    class="table table-striped"
                    id="metricsComparisonTable"
                  >
                    <thead>
                      <tr>
                        <th>Strategie</th>
                        <th>Endkapital</th>
                        <th>Rendite</th>
                        <th>Trades</th>
                      </tr>
                    </thead>
                    <tbody id="metricsTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Return Distribution -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Rendite-Verteilung</h5>
              </div>
              <div class="card-body">
                <canvas
                  id="returnDistributionChart"
                  style="max-height: 400px"
                ></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading -->
      <div id="loadingContainer" style="display: none">
        <div class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Vergleiche Strategien...</p>
        </div>
      </div>

      <!-- Error -->
      <div id="errorContainer" style="display: none">
        <div class="alert alert-danger">
          <h4 class="alert-heading">
            <i class="fas fa-exclamation-triangle"></i> Fehler!
          </h4>
          <p id="errorText"></p>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let availableStrategies = [];

      // Load available strategies on page load
      document.addEventListener("DOMContentLoaded", function () {
        checkForCachedResults();
      });

      async function checkForCachedResults() {
        // Check if there are cached results from a recent backtest
        // This is a simplified check - in a real app you might use sessionStorage or make an API call
        try {
          const response = await fetch("/api/config");
          const result = await response.json();

          if (result.success) {
            // Try to get some basic strategy info
            loadAvailableStrategies();
          }
        } catch (error) {
          console.error("Error checking for cached results:", error);
        }
      }

      function loadAvailableStrategies() {
        // For demo purposes, we'll show the standard strategies
        // In a real implementation, this would come from the backend
        availableStrategies = [
          { id: 0, name: "RSI", color: "#FF6384" },
          { id: 1, name: "SMA", color: "#36A2EB" },
          { id: 2, name: "EMA", color: "#FFCE56" },
          { id: 3, name: "MACD", color: "#4BC0C0" },
          { id: 4, name: "Bollinger", color: "#9966FF" },
          { id: 5, name: "Stochastic", color: "#FF9F40" },
          { id: 6, name: "Momentum", color: "#FF6384" },
          { id: 7, name: "Mean Reversion", color: "#36A2EB" },
          { id: 8, name: "Buy & Hold", color: "#FFCE56" },
        ];

        displayStrategySelection();
      }

      function displayStrategySelection() {
        const container = document.getElementById("strategyCheckboxes");
        const selection = document.getElementById("strategySelection");

        container.innerHTML = "";

        availableStrategies.forEach((strategy) => {
          const div = document.createElement("div");
          div.className = "col-md-4 mb-3";

          div.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${strategy.id}" id="strategy${strategy.id}">
                        <label class="form-check-label" for="strategy${strategy.id}">
                            ${strategy.name}
                        </label>
                    </div>
                `;

          container.appendChild(div);
        });

        selection.style.display = "block";
      }

      function selectAllStrategies() {
        const checkboxes = document.querySelectorAll(
          '#strategyCheckboxes input[type="checkbox"]'
        );
        checkboxes.forEach((checkbox) => (checkbox.checked = true));
      }

      function clearSelection() {
        const checkboxes = document.querySelectorAll(
          '#strategyCheckboxes input[type="checkbox"]'
        );
        checkboxes.forEach((checkbox) => (checkbox.checked = false));
      }

      async function compareSelectedStrategies() {
        const selectedIds = [];
        const checkboxes = document.querySelectorAll(
          '#strategyCheckboxes input[type="checkbox"]:checked'
        );

        checkboxes.forEach((checkbox) => {
          selectedIds.push(parseInt(checkbox.value));
        });

        if (selectedIds.length < 2) {
          alert("Bitte wählen Sie mindestens 2 Strategien zum Vergleich aus.");
          return;
        }

        showLoading();

        try {
          const response = await fetch("/api/compare", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ strategy_ids: selectedIds }),
          });

          const result = await response.json();

          if (result.success) {
            displayComparison(result.data);
          } else {
            showError(result.error);
          }
        } catch (error) {
          showError(`Netzwerkfehler: ${error.message}`);
        }
      }

      function displayComparison(data) {
        createPortfolioComparisonChart(data.strategies);
        createMetricsTable(data.strategies);
        createReturnDistributionChart(data.strategies);

        hideLoading();
        document.getElementById("comparisonContainer").style.display = "block";
      }

      let portfolioChart = null;
      let returnChart = null;

      function createPortfolioComparisonChart(strategies) {
        const ctx = document
          .getElementById("portfolioComparisonChart")
          .getContext("2d");

        // Destroy existing chart if it exists
        if (portfolioChart) {
          portfolioChart.destroy();
        }

        const datasets = strategies.map((strategy, index) => {
          // Grün für positive, Rot für negative Rendite
          const isPositive = strategy.return_percentage > 0;
          const lineColor = isPositive ? "#22c55e" : "#ef4444";
          const bgColor = isPositive
            ? "rgba(34, 197, 94, 0.1)"
            : "rgba(239, 68, 68, 0.1)";

          return {
            label: strategy.strategy_name,
            data: strategy.portfolio_values,
            borderColor: lineColor,
            backgroundColor: bgColor,
            borderWidth: 2,
            fill: false,
            tension: 0.1,
          };
        });

        portfolioChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: Array.from(
              { length: strategies[0].portfolio_values.length },
              (_, i) => `Tag ${i + 1}`
            ),
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
              mode: "index",
              intersect: false,
            },
            plugins: {
              title: {
                display: true,
                text: "Portfolio Performance Vergleich",
                font: { size: 18 },
              },
              legend: {
                display: true,
                position: "bottom",
              },
              tooltip: {
                callbacks: {
                  title: function (context) {
                    const dayIndex = context[0].dataIndex;
                    const date = new Date();
                    date.setDate(
                      date.getDate() -
                        (context[0].dataset.data.length - 1 - dayIndex)
                    );
                    return `Tag ${dayIndex} - ${date.toLocaleDateString(
                      "de-CH"
                    )}`;
                  },
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (label) {
                      label += ": ";
                    }
                    label += new Intl.NumberFormat("de-DE", {
                      style: "currency",
                      currency: "USD",
                    }).format(context.parsed.y);
                    return label;
                  },
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Handelstage",
                },
                ticks: {
                  maxTicksLimit: 20,
                  autoSkip: true,
                  maxRotation: 0,
                  minRotation: 0,
                },
              },
              y: {
                title: {
                  display: true,
                  text: "Portfolio Wert ($)",
                },
                beginAtZero: false,
                grace: "5%",
                ticks: {
                  callback: function (value) {
                    return "$" + value.toLocaleString("de-DE");
                  },
                },
              },
            },
          },
        });
      }

      function createMetricsTable(strategies) {
        const tbody = document.getElementById("metricsTableBody");
        tbody.innerHTML = "";

        strategies.forEach((strategy) => {
          const row = document.createElement("tr");

          const performanceClass =
            strategy.return_percentage > 0
              ? "performance-positive"
              : strategy.return_percentage < 0
              ? "performance-negative"
              : "performance-neutral";

          row.innerHTML = `
                    <td><strong>${strategy.strategy_name}</strong></td>
                    <td>${formatCurrency(strategy.final_value)}</td>
                    <td class="${performanceClass}">${strategy.return_percentage.toFixed(
            2
          )}%</td>
                    <td><span class="badge bg-secondary">${
                      strategy.total_trades
                    }</span></td>
                `;

          tbody.appendChild(row);
        });
      }

      function createReturnDistributionChart(strategies) {
        const ctx = document
          .getElementById("returnDistributionChart")
          .getContext("2d");

        // Destroy existing chart if it exists
        if (returnChart) {
          returnChart.destroy();
        }

        const colors = strategies.map((s) =>
          s.return_percentage > 0 ? "#22c55e" : "#ef4444"
        );

        returnChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: strategies.map((s) => s.strategy_name),
            datasets: [
              {
                label: "Rendite (%)",
                data: strategies.map((s) => s.return_percentage),
                backgroundColor: colors,
                borderColor: colors,
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              title: {
                display: true,
                text: "Rendite-Vergleich",
                font: { size: 18 },
              },
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return "Rendite: " + context.parsed.y.toFixed(2) + "%";
                  },
                },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Strategien",
                },
              },
              y: {
                title: {
                  display: true,
                  text: "Rendite (%)",
                },
                ticks: {
                  callback: function (value) {
                    return value.toFixed(1) + "%";
                  },
                },
              },
            },
          },
        });
      }

      function showLoading() {
        document.getElementById("loadingContainer").style.display = "block";
        document.getElementById("comparisonContainer").style.display = "none";
        document.getElementById("errorContainer").style.display = "none";
      }

      function hideLoading() {
        document.getElementById("loadingContainer").style.display = "none";
      }

      function showError(error) {
        document.getElementById("errorText").textContent = error;
        document.getElementById("errorContainer").style.display = "block";
        hideLoading();
      }

      function formatCurrency(value) {
        return new Intl.NumberFormat("de-DE", {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        }).format(value);
      }
    </script>
  </body>
</html>
